{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash
set -e

echo "==> Installing packages for Linux..."

# Detect package manager
if command -v apt &> /dev/null; then
    PKG_MANAGER="apt"
elif command -v dnf &> /dev/null; then
    PKG_MANAGER="dnf"
elif command -v pacman &> /dev/null; then
    PKG_MANAGER="pacman"
else
    echo "No supported package manager found"
    exit 1
fi

echo "Detected package manager: $PKG_MANAGER"

# Install packages based on package manager
case $PKG_MANAGER in
    apt)
        sudo apt update
        sudo apt install -y \
            git \
            curl \
            wget \
            unzip \
            jq \
            ripgrep \
            fd-find \
            fzf \
            htop \
            tree \
            zsh \
            build-essential

        # Create fd symlink (Ubuntu names it fdfind)
        [ ! -L /usr/local/bin/fd ] && sudo ln -sf $(which fdfind) /usr/local/bin/fd 2>/dev/null || true
        ;;
    dnf)
        sudo dnf install -y \
            git \
            curl \
            wget \
            unzip \
            jq \
            ripgrep \
            fd-find \
            fzf \
            htop \
            tree \
            zsh \
            gcc \
            make
        ;;
    pacman)
        sudo pacman -Syu --noconfirm \
            git \
            curl \
            wget \
            unzip \
            jq \
            ripgrep \
            fd \
            fzf \
            htop \
            tree \
            zsh \
            base-devel
        ;;
esac

# Install Homebrew for additional tools (works on Linux too)
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# Install tools via Homebrew that aren't in standard repos or need newer versions
if command -v brew &> /dev/null; then
    brew install eza bat git-delta lazygit neovim starship zoxide gh
fi

# Install JetBrains Mono Nerd Font
FONT_DIR="${HOME}/.local/share/fonts"
mkdir -p "$FONT_DIR"
if [ ! -f "$FONT_DIR/JetBrainsMonoNerdFont-Regular.ttf" ]; then
    echo "Installing JetBrains Mono Nerd Font..."
    curl -fLo /tmp/JetBrainsMono.zip https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.zip
    unzip -o /tmp/JetBrainsMono.zip -d "$FONT_DIR"
    fc-cache -fv
    rm /tmp/JetBrainsMono.zip
fi

# Set zsh as default shell if not already
if [ "$SHELL" != "$(which zsh)" ]; then
    echo "Setting zsh as default shell..."
    chsh -s $(which zsh)
fi

echo "==> Done!"
{{ end -}}
